/******************************************************************************************
*
*   MODULE:
*       motor.c
*
*   DESCRIPTION:
*       This file includes procedures for motors.
*
*   Created by Seongkwan Lee on Oct 27, 2020
*
******************************************************************************************/


/*-----------------------------------------------------------------------------------------
                                     GENERAL INCLUDES
-----------------------------------------------------------------------------------------*/

#include "motor.h"

/*-----------------------------------------------------------------------------------------
                                  DESIGN ASSURANCE LEVEL
-----------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------
                                         MACROS
-----------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------
                                    LITERAL CONSTANTS
-----------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------
                                           TYPES
-----------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------
                                     PROJECT INCLUDES
-----------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------
                                     MEMORY CONSTANTS
-----------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------
                                        VARIABLES
-----------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------
                                       PROCEDURES
-----------------------------------------------------------------------------------------*/


/********************************************************************
*
*   PROCEDURE NAME:
*       motor_init
*
*   DESCRIPTION:
*       Initializes the motors
*
********************************************************************/

void motor_init
    (
    void
    )
{
/*---------------------------------------------------------
P5.5 DIRR
---------------------------------------------------------*/
gpio( P5, 5 );
sbo( P5, 5 );

/*---------------------------------------------------------
P3.6 nSLPR
---------------------------------------------------------*/
gpio( P3, 6 );
sbo( P3, 6 );

/*---------------------------------------------------------
P2.6 PWMR
---------------------------------------------------------*/
gpio( P2, 6 );
sbo( P2, 6 );

/*---------------------------------------------------------
P5.4 DIRL
---------------------------------------------------------*/
gpio( P5, 4 );
sbo( P5, 4 );

/*---------------------------------------------------------
P3.7 nSLPL
---------------------------------------------------------*/
gpio( P3, 7 );
sbo( P3, 7 );

/*---------------------------------------------------------
P2.7 PWML
---------------------------------------------------------*/
gpio( P2, 7 );
sbo( P2, 7 );

/*---------------------------------------------------------
Put DRV8838 Drivers to sleep.
---------------------------------------------------------*/
out_bit_off( P2, 6 );
out_bit_off( P3, 6 );
out_bit_off( P2, 7 );
out_bit_off( P3, 7 );

/*---------------------------------------------------------
Initialize the PWM 3 and 4 to 0 duty cycle.
---------------------------------------------------------*/
pwm_3_4_init( PERIOD_VALUE, INITIAL_DUTY, INITIAL_DUTY );

}   /* motor_init() */


/********************************************************************
*
*   PROCEDURE NAME:
*       motor_stop
*
*   DESCRIPTION:
*       Stops the motors
*
********************************************************************/

void motor_stop
    (
    void
    )
{
/*---------------------------------------------------------
Put DRV8838 Drivers to sleep.
---------------------------------------------------------*/
out_bit_off( P2, 6 );
out_bit_off( P3, 6 );
out_bit_off( P2, 7 );
out_bit_off( P3, 7 );

/*---------------------------------------------------------
Initialize the PWM 3 and 4 to 0 duty cycle.
---------------------------------------------------------*/
pwm_3_4_init( PERIOD_VALUE, INITIAL_DUTY, INITIAL_DUTY );

}   /* motor_stop() */


/********************************************************************
*
*   PROCEDURE NAME:
*       motor_move_forward
*
*   DESCRIPTION:
*       Drives the robot forward
*
********************************************************************/

void motor_move_forward
    (
    uint16_t            leftDuty,   /* Duty cycle of left motor    */
    uint16_t            rightDuty   /* Duty cycle of right motor   */
    )
{
/*---------------------------------------------------------
Set Direction.
---------------------------------------------------------*/
out_bit_on( P2, 6 );
out_bit_on( P3, 6 );
out_bit_on( P2, 7 );
out_bit_on( P3, 7 );

out_bit_on( P5, 4 );
out_bit_on( P5, 5 );

pwm_3_duty( leftDuty );
pwm_4_duty( rightDuty );

}   /* motor_move_forward() */


/********************************************************************
*
*   PROCEDURE NAME:
*       motor_run
*
*   DESCRIPTION:
*       Drives a motor
*
********************************************************************/

void motor_run
    (
    motor_side_t        motor_side,/* Motor side to run            */
    int16_t             duty       /* Duty cycle of the motor      */
    )
{
/*---------------------------------------------------------
Local Variables
---------------------------------------------------------*/
uint16_t newDuty;

/*---------------------------------------------------------
Run motor according to the given motor.
---------------------------------------------------------*/
if( motor_side == MOTOR_LEFT )
    {
    /*-----------------------------------------------------
    Set nSleep and PWM pins to high.
    -----------------------------------------------------*/
    out_bit_on( P2, 7 );
    out_bit_on( P3, 7 );

    /*-----------------------------------------------------
    Set Motor direction.
    -----------------------------------------------------*/
    if( duty < 0 )
        {
        out_bit_on( P5, 4 );
        }
    else
        {
        out_bit_off( P5, 4 );
        }

    newDuty = ( uint16_t )fabs( duty );
    pwm_3_duty( newDuty );
    }
else
    {
    /*-----------------------------------------------------
    Set nSleep and PWM pins to high.
    -----------------------------------------------------*/
    out_bit_on( P2, 6 );
    out_bit_on( P3, 6 );

    /*-----------------------------------------------------
    Set Motor direction.
    -----------------------------------------------------*/
    if( duty < 0 )
        {
        out_bit_on( P5, 5 );
        }
    else
        {
        out_bit_off( P5, 5 );
        }

    newDuty = ( uint16_t )fabs( duty );
    pwm_4_duty( newDuty );
    }

}   /* motor_run() */


/********************************************************************
*
*   PROCEDURE NAME:
*       motor_move_with_forward_and_turn
*
*   DESCRIPTION:
*       Drives with linear and angular speed
*
********************************************************************/

void motor_move_with_forward_and_turn
    (
    int16_t             x,         /* Linear speed                 */
    int16_t             turn       /* Angular speed                */
    )
{
/*---------------------------------------------------------
Local Variables
---------------------------------------------------------*/
int16_t left;
int16_t right;

/*---------------------------------------------------------
Calculate motor speed on each side.
---------------------------------------------------------*/
left  = x / 2 + turn / 2;
right = x / 2 - turn / 2;

/*---------------------------------------------------------
Run each side motor.
---------------------------------------------------------*/
motor_run( MOTOR_LEFT,  left  );
motor_run( MOTOR_RIGHT, right );

}   /* motor_move_with_forward_and_turn() */
